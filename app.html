<!DOCTYPE html>
<html>
<body>
<script>
const API="https://script.google.com/macros/s/AKfycbz_eRBwlJFh0CWREKw8i56HzkIb9OnWsxNuuNzOEHfcAofjw7ChKKvmXnETLjnw0UVn/exec";
const u=JSON.parse(localStorage.getItem("u"));
if(!u)location="index.html";
</script>

<h2 id="title"></h2>
<button onclick="sec('dash')">Dashboard</button>
<button onclick="sec('visit')">Visits</button>
<button onclick="sec('rep')">Reports</button>
<button onclick="sec('usr')">Users</button>
<button onclick="sec('set')">Settings</button>
<button onclick="logout()">Logout</button>

<div id="dash"></div>
<div id="visit"></div>
<div id="rep"></div>
<div id="usr"></div>
<div id="set"></div>

<script>
title.innerText=u.role+" â€“ "+u.user_name;

function sec(id){
["dash","visit","rep","usr","set"].forEach(x=>document.getElementById(x).innerHTML="");
if(id=="dash")dash();
if(id=="visit")visit();
if(id=="rep")report();
if(id=="usr"&&u.role=="ADMIN")users();
if(id=="set")settings();
}

function dash(){
fetch(API,{method:"POST",body:JSON.stringify({action:"getDashboard",role:u.role,user_id:u.user_id})})
.then(r=>r.json()).then(d=>{
dash.innerHTML=`Today:${d.today} Month:${d.month} Pending:${d.pending} Users:${d.users}`;
});
}

function visit(){
visit.innerHTML=`
<input id=c placeholder=Client>
<input id=l placeholder=Location>
<textarea id=s></textarea>
<select id=st><option>Pending</option><option>Completed</option></select>
<button onclick=sv()>Save</button>`;
}

function sv(){
navigator.geolocation.getCurrentPosition(p=>{
fetch(API,{method:"POST",body:JSON.stringify({
action:"addVisit",user_id:u.user_id,user_name:u.user_name,
client:c.value,location:l.value,summary:s.value,status:st.value,
lat:p.coords.latitude,lng:p.coords.longitude
})}).then(()=>alert("Saved"));
});
}

function report(){
rep.innerHTML=`<input id=f type=date><input id=t type=date>
<button onclick=gr()>Generate</button><table id=rt></table>`;
}

function gr(){
fetch(API,{method:"POST",body:JSON.stringify({
action:"getReport",role:u.role,user_id:u.user_id,from:f.value,to:t.value
})}).then(r=>r.json()).then(d=>{
rt.innerHTML=d.data.map(x=>`<tr><td>${x.date}</td><td>${x.user}</td><td>${x.client}</td><td>${x.status}</td></tr>`).join("");
});
}

function users(){
fetch(API,{method:"POST",body:JSON.stringify({action:"getUsers",role:u.role})})
.then(r=>r.json()).then(d=>{
usr.innerHTML=d.users.map(x=>`${x.name} ${x.role} ${x.status}<br>`).join("");
});
}

function settings(){
set.innerHTML=`<input id=np placeholder="New Password">
<button onclick=rp()>Reset</button>`;
}

function rp(){
fetch(API,{method:"POST",body:JSON.stringify({
action:"resetPassword",user_id:u.user_id,target:u.user_id,password:np.value,role:u.role
})}).then(()=>alert("Changed"));
}

function logout(){localStorage.clear();location="index.html";}
sec(u.role=="BDO"||u.role=="ABDM"?"visit":"dash");
</script>
</body>
</html>
