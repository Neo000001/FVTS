<!DOCTYPE html>
<html>
<head>
<title>Field Visit App</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;font-family:Arial;background:#f4f6f8}
.app{display:flex;height:100vh}
.sidebar{width:220px;background:#1f3a5f;color:#fff}
.sidebar button{width:100%;padding:12px;border:none;background:none;color:#fff;text-align:left}
.sidebar button:hover{background:#16304f}
.main{flex:1;padding:20px;overflow:auto}
.container{background:#fff;padding:20px;border-radius:8px}
.hidden{display:none}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #ccc;padding:6px;text-align:left}
</style>
</head>

<body>

<div class="app">
  <div class="sidebar">
    <button onclick="show('users')">ðŸ‘¥ User Master</button>
    <button onclick="logout()">ðŸšª Logout</button>
  </div>

  <div class="main">

    <!-- USER MASTER -->
    <div class="container hidden" id="usersBox">
      <h3>User Master</h3>
      Total Users: <b><span id="userCount">0</span></b>

      <table>
        <thead>
          <tr>
            <th>Name</th><th>Mobile</th><th>Role</th><th>Status</th><th>Action</th>
          </tr>
        </thead>
        <tbody id="userTable"></tbody>
      </table>

      <hr>

      <h4>Create / Edit User</h4>
      <input id="u_id" type="hidden">
      <input id="u_name" placeholder="Name">
      <input id="u_mobile" placeholder="Mobile">
      <input id="u_password" placeholder="Password">
      <select id="u_role">
        <option>BDO</option>
        <option>ABDM</option>
        <option>SR_ABDM</option>
        <option>GM</option>
      </select>
      <select id="u_status">
        <option>ACTIVE</option>
        <option>INACTIVE</option>
      </select>
      <button onclick="saveUser()">Save</button>
    </div>

  </div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbyX4vdPwU1bHeiXFHAMt5usBueFtsbS4_pEo73tDUOxdNm2wNASpbI8EtFLOSTnqhJJGw/exec";
const user=JSON.parse(localStorage.getItem("user"));
if(!user||user.role!=="ADMIN")location.href="login.html";

show("users");

function show(s){
  usersBox.classList.add("hidden");
  if(s==="users"){usersBox.classList.remove("hidden");loadUsers();}
}

function loadUsers(){
  fetch(API,{method:"POST",body:JSON.stringify({action:"getUsers",requester_role:user.role})})
  .then(r=>r.json()).then(d=>{
    userCount.innerText=d.users.length;
    userTable.innerHTML="";
    d.users.forEach(u=>{
      userTable.innerHTML+=`
      <tr>
        <td>${u.name}</td>
        <td>${u.mobile}</td>
        <td>${u.role}</td>
        <td>${u.status}</td>
        <td>
          <button onclick='edit(${JSON.stringify(u)})'>Edit</button>
          <button onclick="toggle('${u.user_id}','${u.status==="ACTIVE"?"INACTIVE":"ACTIVE"}')">
            ${u.status==="ACTIVE"?"Deactivate":"Activate"}
          </button>
        </td>
      </tr>`;
    });
  });
}

function edit(u){
  u_id.value=u.user_id;
  u_name.value=u.name;
  u_mobile.value=u.mobile;
  u_role.value=u.role;
  u_status.value=u.status;
}

function saveUser(){
  if(u_id.value){
    fetch(API,{method:"POST",body:JSON.stringify({
      action:"updateUser",
      requester_role:user.role,
      user_id:u_id.value,
      name:u_name.value,
      role:u_role.value,
      status:u_status.value
    })}).then(()=>loadUsers());
  }else{
    fetch(API,{method:"POST",body:JSON.stringify({
      action:"addUser",
      requester_role:user.role,
      name:u_name.value,
      mobile:u_mobile.value,
      password:u_password.value,
      role:u_role.value
    })}).then(()=>loadUsers());
  }
}

function toggle(id,status){
  fetch(API,{method:"POST",body:JSON.stringify({
    action:"toggleUserStatus",
    requester_role:user.role,
    user_id:id,
    status
  })}).then(()=>loadUsers());
}

function logout(){localStorage.clear();location.href="login.html";}
</script>

</body>
</html>
