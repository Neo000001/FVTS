<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Field Visit System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f4f6f8;
}
.app {
  display: flex;
  height: 100vh;
}

/* SIDEBAR */
.sidebar {
  width: 230px;
  background: #1f3a5f;
  color: #fff;
  display: flex;
  flex-direction: column;
}
.sidebar h2 {
  text-align: center;
  padding: 15px 0;
  margin: 0;
  border-bottom: 1px solid #16304f;
}
.sidebar button {
  padding: 12px 15px;
  border: none;
  background: none;
  color: #fff;
  text-align: left;
  cursor: pointer;
  font-size: 14px;
}
.sidebar button:hover {
  background: #16304f;
}

/* MAIN */
.main {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}
.section {
  display: none;
}
.section.active {
  display: block;
}
.container {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
}

.kpi-wrap {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}
.kpi {
  background: #eef2f7;
  padding: 15px;
  border-radius: 6px;
  text-align: center;
  font-size: 14px;
}
.note {
  font-size: 13px;
  color: #777;
}
</style>
</head>

<body>

<div class="app">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <h2>Field Visit</h2>

    <button id="menuDashboard" onclick="showSection('dashboard')">ğŸ“Š Dashboard</button>
    <button id="menuVisits" onclick="showSection('visits')">ğŸ“ Visits / Site Entry</button>
    <button id="menuReports" onclick="showSection('reports')">ğŸ“‘ Reports</button>
    <button id="menuUsers" onclick="showSection('users')">ğŸ‘¥ User Management</button>
    <button id="menuSettings" onclick="showSection('settings')">âš™ï¸ Settings</button>

    <button onclick="logout()">ğŸšª Logout</button>
  </div>

  <!-- MAIN -->
  <div class="main">

    <!-- DASHBOARD -->
    <div id="dashboard" class="section">
      <div class="container">
        <h3>Dashboard</h3>

        <div class="kpi-wrap">
          <div class="kpi">Today Visits<br><b id="k_today">0</b></div>
          <div class="kpi">Month Visits<br><b id="k_month">0</b></div>
          <div class="kpi">Pending Follow-ups<br><b id="k_pending">0</b></div>
          <div class="kpi">Active Users<br><b id="k_users">0</b></div>
        </div>

        <br>
        <canvas id="dateChart"></canvas>
        <br>
        <canvas id="userChart"></canvas>
      </div>
    </div>

    <!-- VISITS -->
    <div id="visits" class="section">
      <div class="container">
        <h3>Visits / Site Entry</h3>
        <p class="note">
          Visit entry form + visit history will be plugged here next.
        </p>
      </div>
    </div>

    <!-- REPORTS -->
    <div id="reports" class="section">
      <div class="container">
        <h3>Reports</h3>
        <p class="note">
          Date / User / Branch filters + export.
        </p>
      </div>
    </div>

    <!-- USER MANAGEMENT -->
    <div id="users" class="section">
      <div class="container">
        <h3>User Management</h3>
        <p class="note">
          User master (create / edit / activate / deactivate).
        </p>
      </div>
    </div>

    <!-- SETTINGS -->
    <div id="settings" class="section">
      <div class="container">
        <h3>Settings</h3>
        <p class="note">
          Password reset (self + admin reset).
        </p>
      </div>
    </div>

  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ================= CONFIG ================= */
const API = "https://script.google.com/macros/s/AKfycby5CPy0pBMpmAlqpy3SJadJ_oClIS3GzYFgIqeaVK49HYx1Kg0cqWYZTM4LnprPx484uw/exec";

/* ================= SESSION ================= */
const user = JSON.parse(localStorage.getItem("user"));
if (!user) {
  window.location.href = "login.html";
}

/* ================= ROLE MENU ================= */
if (user.role === "BDO" || user.role === "ABDM") {
  hide("menuDashboard");
  hide("menuReports");
  hide("menuUsers");
  hide("menuSettings");
}

if (user.role === "GM") {
  hide("menuVisits");
  hide("menuUsers");
}

if (user.role === "SR_ABDM") {
  hide("menuUsers");
}

/* ================= DEFAULT PAGE ================= */
if (["ADMIN", "GM", "SR_ABDM"].includes(user.role)) {
  showSection("dashboard");
} else {
  showSection("visits");
}

/* ================= FUNCTIONS ================= */
function hide(id) {
  document.getElementById(id).style.display = "none";
}

function showSection(id) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");

  if (id === "dashboard") loadDashboard();
}

function logout() {
  localStorage.clear();
  window.location.href = "login.html";
}

/* ================= DASHBOARD ================= */
let dateChartObj, userChartObj;

function loadDashboard() {
  fetch(API, {
    method: "POST",
    body: JSON.stringify({ action: "getDashboard" })
  })
  .then(r => r.json())
  .then(d => {
    if (!d.success) return;

    k_today.innerText = d.todayCount;
    k_month.innerText = d.monthCount;
    k_pending.innerText = d.pendingFollowups;
    k_users.innerText = d.activeUsers;

    const dates = Object.keys(d.visitsByDate).slice(-7);
    const dateVals = dates.map(k => d.visitsByDate[k]);

    if (dateChartObj) dateChartObj.destroy();
    dateChartObj = new Chart(dateChart, {
      type: "line",
      data: {
        labels: dates,
        datasets: [{ label: "Visits", data: dateVals }]
      }
    });

    const users = Object.keys(d.visitsByUser);
    const userVals = users.map(u => d.visitsByUser[u]);

    if (userChartObj) userChartObj.destroy();
    userChartObj = new Chart(userChart, {
      type: "bar",
      data: {
        labels: users,
        datasets: [{ label: "Visits", data: userVals }]
      }
    });
  });
}
</script>

</body>
</html>
