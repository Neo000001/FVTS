<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
const admin = JSON.parse(localStorage.getItem("admin"));
if(!admin || admin.role !== "ADMIN"){
  location.href = "index.html";
}
</script>

<style>
body{margin:0;font-family:Arial;background:#f4f6f8}
header{background:#1f3a5f;color:#fff;padding:15px;display:flex;justify-content:space-between;align-items:center}
button{padding:8px 12px;border:none;cursor:pointer;background:#1f3a5f;color:#fff;border-radius:4px}
button:hover{opacity:.9}
.main{padding:20px}
.card{background:#fff;padding:15px;border-radius:6px;margin-bottom:15px}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.kpi{background:#eef2f7;padding:15px;border-radius:6px;text-align:center}
table{width:100%;border-collapse:collapse;font-size:13px;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px}
th{background:#eef2f7}
input,select{width:100%;padding:6px;margin-top:5px}
.section{display:none}
.section.active{display:block}
</style>
</head>

<body>

<header>
  <b>ADMIN PANEL â€“ <span id="adminName"></span></b>
  <button onclick="logout()">Logout</button>
</header>

<div class="main">

<div class="card">
  <button onclick="show('dash')">Dashboard</button>
  <button onclick="show('report')">Reports</button>
  <button onclick="show('users')">Users</button>
</div>

<!-- DASHBOARD -->
<div id="dash" class="section active card">
  <h3>Dashboard</h3>
  <div class="grid">
    <div class="kpi">Today<br><b id="d_today">0</b></div>
    <div class="kpi">Yesterday<br><b id="d_yest">0</b></div>
    <div class="kpi">Month<br><b id="d_month">0</b></div>
    <div class="kpi">Pending<br><b id="d_pending">0</b></div>
    <div class="kpi">Total Visits<br><b id="d_total">0</b></div>
    <div class="kpi">Active Users<br><b id="d_users">0</b></div>
  </div>
</div>

<!-- REPORTS -->
<div id="report" class="section card">
  <h3>Reports</h3>
  <div class="grid">
    <input type="date" id="r_from">
    <input type="date" id="r_to">
    <input id="r_user" placeholder="User name (optional)">
  </div>
  <br>
  <button onclick="loadReport()">Generate</button>

  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>User</th>
        <th>Client</th>
        <th>Hospital</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="reportTable"></tbody>
  </table>
</div>

<!-- USERS -->
<div id="users" class="section card">
  <h3>User Management</h3>

  <h4>Create User</h4>
  <div class="grid">
    <input id="u_name" placeholder="Name">
    <input id="u_mobile" placeholder="Mobile">
    <input id="u_pass" placeholder="Password">
    <select id="u_role">
      <option>ADMIN</option>
      <option>GM</option>
      <option>SR_ABDM</option>
      <option>ABDM</option>
      <option>BDO</option>
    </select>
  </div>
  <br>
  <button onclick="createUser()">Create User</button>

  <h4 style="margin-top:20px">Existing Users</h4>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Mobile</th>
        <th>Role</th>
        <th>Status</th>
        <th>New Password</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="userTable"></tbody>
  </table>
</div>

</div>

<script>
const API="https://script.google.com/macros/s/AKfycbzTonV2ptom3z_PqSdt8T4BNqkw8hliy-umA_ZmV0MhkmClAnF23D1HEp6KTDHbN7d24Q/exec";

document.getElementById("adminName").innerText = admin.user_name;

function show(id){
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

function logout(){
  localStorage.clear();
  location.href="index.html";
}

/* DASHBOARD */
fetch(API,{method:"POST",body:JSON.stringify({action:"adminDashboard"})})
.then(r=>r.json()).then(d=>{
  d_today.innerText=d.todayCount;
  d_yest.innerText=d.yesterdayCount;
  d_month.innerText=d.monthCount;
  d_pending.innerText=d.pendingCount;
  d_total.innerText=d.totalVisits;
  d_users.innerText=d.activeUsers;
});

/* REPORT */
function loadReport(){
  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"adminReport",
      from:r_from.value,
      to:r_to.value,
      user:r_user.value
    })
  })
  .then(r=>r.json())
  .then(d=>{
    reportTable.innerHTML="";
    d.data.forEach(x=>{
      reportTable.innerHTML+=`
      <tr>
        <td>${x.date}</td>
        <td>${x.user}</td>
        <td>${x.client}</td>
        <td>${x.hospital}</td>
        <td>${x.status}</td>
      </tr>`;
    });
  });
}

/* USERS */
function loadUsers(){
  fetch(API,{method:"POST",body:JSON.stringify({action:"adminGetUsers"})})
  .then(r=>r.json())
  .then(d=>{
    userTable.innerHTML="";
    d.users.forEach(u=>{
      userTable.innerHTML+=`
      <tr>
        <td>${u.name}</td>
        <td>${u.mobile}</td>
        <td>
          <select onchange="updateUser('${u.user_id}',this.value,'${u.status}')">
            <option ${u.role=="ADMIN"?"selected":""}>ADMIN</option>
            <option ${u.role=="GM"?"selected":""}>GM</option>
            <option ${u.role=="SR_ABDM"?"selected":""}>SR_ABDM</option>
            <option ${u.role=="ABDM"?"selected":""}>ABDM</option>
            <option ${u.role=="BDO"?"selected":""}>BDO</option>
          </select>
        </td>
        <td>
          <select onchange="updateUser('${u.user_id}','${u.role}',this.value)">
            <option ${u.status=="ACTIVE"?"selected":""}>ACTIVE</option>
            <option ${u.status=="INACTIVE"?"selected":""}>INACTIVE</option>
          </select>
        </td>
        <td><input id="p_${u.user_id}" placeholder="New password"></td>
        <td><button onclick="resetPass('${u.user_id}')">Reset</button></td>
      </tr>`;
    });
  });
}

function createUser(){
  if(!u_name.value||!u_mobile.value||!u_pass.value){
    alert("Fill all fields"); return;
  }

  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"adminCreateUser",
      name:u_name.value,
      mobile:u_mobile.value,
      password:u_pass.value,
      role:u_role.value,
      created_by: admin.user_id
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(!d.success){alert("Create failed");return;}
    alert("User created");
    u_name.value="";u_mobile.value="";u_pass.value="";
    loadUsers();
  });
}

function updateUser(id,role,status){
  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"adminUpdateUser",
      user_id:id,
      role:role,
      status:status,
      updated_by: admin.user_id
    })
  });
}

function resetPass(id){
  const pass=document.getElementById("p_"+id).value;
  if(!pass){alert("Enter password");return;}

  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"adminResetPassword",
      user_id:id,
      new_password:pass,
      updated_by: admin.user_id
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(!d.success){alert("Reset failed");return;}
    alert("Password reset successful");
    document.getElementById("p_"+id).value="";
  });
}

loadUsers();
</script>

</body>
</html>
